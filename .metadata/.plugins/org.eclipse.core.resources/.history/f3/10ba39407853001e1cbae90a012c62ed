/*
 * passwordDoor.c
 *
 *  Created on: Sep 1, 2023
 *      Author: MyLinh
 */

#include "passwordDoor.h"
#include "tim.h"

unsigned char arrayMapOfNumber[8] = { 1, 2, 3, 4, 5, 6, 7, 8 };
unsigned char arrayMapOfPassword[4] = { 2, 2, 2, 2 };
unsigned char arrayPassword[4] = { 0, 0, 0, 0 };
uint16_t statusPassword = 0;
uint16_t indexOfNumber = 0;
uint16_t numberValue;
uint16_t timeDelay = 0;
uint16_t flag = 0;
uint16_t preStatus = 0;
uint16_t stateOfSystem = 0;

#define INIT_SYSTEM		0
#define ENTER_PASSWORD	1
#define CHANGE_PASSWORD	2
#define UNLOCK_DOOR		3
#define WRONG_PASSWORD	4
#define CHECK_PASSWORD	5

uint16_t isButtonNumber() {
	for (int i = 0; i < 8; i++)
		if (button_count[i] == 1) {
			numberValue = arrayMapOfNumber[i];
			return 1;
		}
	return 0;
}

//uint16_t setPassword() {
//
//}

uint16_t checkPassword() {
	for (int i = 0; i < 4; i++) {
		if (arrayPassword[i] != arrayMapOfPassword[i]) {
			return 0;
		}
	}
	return 1;
}

void UnlockDoor() {
	//..............
}

void LockDoor() {
	//..............
}

void App_PasswordDoor() {
	LockDoor();
	switch (statusPassword) {
	case INIT_SYSTEM:
		__HAL_TIM_SET_COMPARE(&htim13, TIM_CHANNEL_1, 0);
		LCD_ShowPicture(17, 25, 206, 50, gImage_press1);
		LCD_ShowPicture(80, 100, 77, 130, gImage_door1);
		LCD_ShowPicture(107, 265, 30, 32, gImage_protect);

		if (button_count[0] == 1) {
			indexOfNumber = 0;
			timeDelay = 0;
			statusPassword = ENTER_PASSWORD;

			LCD_Fill(30, 25, 210, 80, WHITE);		//clear text
			LCD_Fill(30, 265, 210, 300, WHITE);		//clear protect

			LCD_ShowPicture(17, 25, 206, 48, gImage_enterPW);
			LCD_ShowPicture(17, 235, 206, 30, gImage_PW);
		}
		break;

	case ENTER_PASSWORD:
		timeDelay++;

		if (isButtonNumber()) {
			LCD_ShowString(70 + indexOfNumber * 30, 242, "*", BLACK, LIGHTGRAY,
					16, 0);
			arrayPassword[indexOfNumber] = numberValue;
			indexOfNumber++;
			timeDelay = 0;
		}

		if (indexOfNumber >= 4) {
			statusPassword = CHECK_PASSWORD;
		}

		if (timeDelay >= 100) {
			statusPassword = INIT_SYSTEM;
			LCD_Fill(20, 20, 220, 300, WHITE);
		}
		break;

	case CHECK_PASSWORD:
		timeDelay = 0;
		if (checkPassword()) {
			statusPassword = UNLOCK_DOOR;
			timeDelay = 0;
			flag = 1;
		} else {
			statusPassword = WRONG_PASSWORD;
		}

		LCD_Fill(20, 20, 220, 300, WHITE);

		break;

	case UNLOCK_DOOR:
		timeDelay++;
		UnlockDoor();

		if (flag == 1)
		{
			LCD_ShowPicture(17, 30, 206, 23, gImage_doorOpened);
			LCD_ShowPicture(80, 90, 77, 130, gImage_door2);
			LCD_ShowPicture(80, 90, 77, 130, gImage_door3);
			LCD_ShowPicture(80, 90, 80, 135, gImage_door4);
			LCD_ShowPicture(80, 90, 90, 138, gImage_door5);
			LCD_ShowPicture(80, 90, 98, 138, gImage_door6);
			flag = 0;
		}
		LCD_ShowPicture(80, 90, 112, 138, gImage_door7);


		if (button_count[0]) {
			statusPassword = CHANGE_PASSWORD;
			timeDelay = 0;
			indexOfNumber = 0;
			LCD_Fill(20, 20, 220, 300, WHITE);
			LCD_ShowPicture(17, 25, 206, 47, gImage_enterNewPW);
			LCD_ShowPicture(80, 100, 77, 130, gImage_door1);
			LCD_ShowPicture(17, 235, 206, 30, gImage_PW);
		}

		if (timeDelay >= 100) {
			statusPassword = INIT_SYSTEM;
			LCD_Fill(20, 20, 220, 300, WHITE);
		}
		break;

	case WRONG_PASSWORD:
		timeDelay++;
		__HAL_TIM_SET_COMPARE(&htim13, TIM_CHANNEL_1, 8);
		LCD_ShowPicture(17, 25, 206, 53, gImage_wrongPW);
		LCD_ShowPicture(80, 100, 77, 130, gImage_door1);
		LCD_ShowPicture(17, 235, 206, 30, gImage_PW);
		LCD_ShowPicture(17, 265, 206, 28, gImage_wrong);

		statusPassword = ENTER_PASSWORD;
		indexOfNumber = 0;

		if (timeDelay >= 100) {
			statusPassword = INIT_SYSTEM;
			LCD_Fill(20, 20, 220, 300, WHITE);
		}

		break;
	case CHANGE_PASSWORD:
		timeDelay++;

		if (isButtonNumber()) {
			if (indexOfNumber >= 0 && indexOfNumber <= 3) {
				LCD_ShowString(70 + indexOfNumber * 30, 242, "*", BLACK,
				LIGHTGRAY, 16, 0);
				arrayMapOfPassword[indexOfNumber] = numberValue;
				indexOfNumber++;
				timeDelay = 0;
			}
		}

		if (indexOfNumber >= 4) {
			LCD_ShowPicture(17, 25, 206, 50, gImage_PWSuccessful);
			LCD_ShowPicture(80, 100, 77, 130, gImage_door1);
			LCD_ShowPicture(107, 265, 30, 32, gImage_protect);
		}

		if (timeDelay >= 100) {
			statusPassword = INIT_SYSTEM;
			LCD_Fill(20, 20, 220, 300, WHITE);
		}
		break;
	default:
		break;

	}
}

